{% load i18n ui component_tags %}

{% component "page"
    title=_("Customers")
    module_id="customers"
    tabbar_view="list"
    action_icon="person-add-outline"
    action_label=_("New Customer")
    action_hx_get="/modules/customers/create/"
    action_hx_target="#main-content-area"
    action_hx_push_url="true" %}

    {% fill "content" %}
{# Toast listener for HX-Trigger events #}
<script>
(function() {
    if (!window._customerToastListenerAdded) {
        window._customerToastListenerAdded = true;
        document.body.addEventListener('showToast', function(e) {
            const detail = e.detail || {};
            const message = detail.message || 'Done';
            const color = detail.color || 'success';

            const toast = document.createElement('ion-toast');
            toast.message = message;
            toast.duration = 2000;
            toast.position = 'top';
            toast.color = color;
            document.body.appendChild(toast);
            toast.present();
        });
    }
})();
</script>

{% csrf_token %}

<div id="customer-list-container">
    {# Stats Cards - 4 KPIs for consistency #}
    <ion-row class="mb-md">
        <ion-col size="6" size-md="3">
            {% ui_stat_card value=total_customers label=_("Active") icon="people-outline" color="primary" %}
        </ion-col>
        <ion-col size="6" size-md="3">
            {% ui_stat_card value=inactive_customers label=_("Inactive") icon="person-remove-outline" color="warning" %}
        </ion-col>
        <ion-col size="6" size-md="3">
            {% with total=total_customers|add:inactive_customers %}
            {% ui_stat_card value=total label=_("Total") icon="trending-up-outline" color="success" %}
            {% endwith %}
        </ion-col>
        <ion-col size="6" size-md="3">
            {% ui_stat_card value=new_this_month|default:0 label=_("New This Month") icon="calendar-outline" color="tertiary" %}
        </ion-col>
    </ion-row>

    {# Search and Filters #}
    {% ui_card css_class="mb-md" %}
        <div class="d-flex flex-wrap gap-md align-center">
            <ion-searchbar
                name="search"
                placeholder="{% trans 'Search by name, phone, email...' %}"
                class="flex-1"
                style="min-width: 200px;"
                hx-get="{% url 'customers:list_htmx' %}"
                hx-trigger="ionInput changed delay:300ms"
                hx-target="#customer-table-body"
                hx-include="[name='status']">
            </ion-searchbar>

            <ion-segment value="active" style="max-width: 300px;">
                <ion-segment-button value="active"
                    hx-get="{% url 'customers:list_htmx' %}?status=active"
                    hx-trigger="click"
                    hx-target="#customer-table-body"
                    hx-include="[name='search']">
                    <ion-label>{% trans "Active" %}</ion-label>
                    <input type="hidden" name="status" value="active">
                </ion-segment-button>
                <ion-segment-button value="inactive"
                    hx-get="{% url 'customers:list_htmx' %}?status=inactive"
                    hx-trigger="click"
                    hx-target="#customer-table-body"
                    hx-include="[name='search']">
                    <ion-label>{% trans "Inactive" %}</ion-label>
                </ion-segment-button>
                <ion-segment-button value="all"
                    hx-get="{% url 'customers:list_htmx' %}?status=all"
                    hx-trigger="click"
                    hx-target="#customer-table-body"
                    hx-include="[name='search']">
                    <ion-label>{% trans "All" %}</ion-label>
                </ion-segment-button>
            </ion-segment>
        </div>
        {# Hidden input to track current status filter #}
        <input type="hidden" name="status" id="current-status" value="active">
    {% endui_card %}

    {# Customer List #}
    {% ui_card %}
        <div class="data-table-container" style="max-height: 60vh; overflow-y: auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>{% trans "Name" %}</th>
                        <th>{% trans "Contact" %}</th>
                        <th class="cell-right">{% trans "Total Spent" %}</th>
                        <th class="cell-center">{% trans "Visits" %}</th>
                        <th class="cell-center hide-mobile">{% trans "Last Purchase" %}</th>
                        <th class="cell-actions">{% trans "Actions" %}</th>
                    </tr>
                </thead>
                <tbody id="customer-table-body"
                       hx-get="{% url 'customers:list_htmx' %}"
                       hx-trigger="load"
                       hx-include="[name='status']">
                    {# Initial loading state #}
                    <tr id="loading-row">
                        <td colspan="6">
                            <div class="d-flex justify-center align-center" style="padding: var(--space-xxl);">
                                <ion-spinner name="crescent"></ion-spinner>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    {% endui_card %}
</div>
    {% endfill %}
{% endcomponent %}

<style>
.customer-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(var(--color-primary-rgb), 0.1);
}

.customer-avatar ion-icon {
    font-size: 20px;
    color: var(--color-primary);
}

.customer-visit-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-xxs) var(--space-xs);
    border-radius: var(--border-radius-round);
    background: rgba(var(--color-primary-rgb), 0.1);
    color: var(--color-primary);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    min-width: 24px;
}

.infinite-scroll-loader {
    display: flex;
    justify-content: center;
    padding: var(--space-lg);
}

.infinite-scroll-end {
    text-align: center;
    padding: var(--space-md);
    color: var(--text-color-secondary);
    font-size: var(--font-size-sm);
}
</style>

<script>
// Update status hidden input when segment changes
document.addEventListener('ionChange', function(e) {
    if (e.target.tagName === 'ION-SEGMENT') {
        const statusInput = document.getElementById('current-status');
        if (statusInput) {
            statusInput.value = e.detail.value;
        }
    }
});
</script>
