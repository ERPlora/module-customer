{% load i18n ui component_tags %}

{# Toast listener for HX-Trigger events #}
<script>
(function() {
    if (!window._customersToastListenerAdded) {
        window._customersToastListenerAdded = true;
        document.body.addEventListener('showToast', function(e) {
            var detail = e.detail || {};
            var message = detail.message || 'Done';
            var color = detail.color || 'success';

            var toast = document.createElement('ion-toast');
            toast.message = message;
            toast.duration = 2000;
            toast.position = 'top';
            toast.color = color;
            document.body.appendChild(toast);
            toast.present();
        });
    }
})();
</script>

{% url 'customers:list' as back_url %}
{% component "page"
    title=customer|yesno:_("Edit Customer"),_("New Customer")
    subtitle=customer.name|default:""
    module_id="customers"
    hide_tabbar=True
    back_url=back_url
    back_hx_target="#main-content-area" %}

    {% fill "content" %}
    {% ui_card %}
        <form id="customer-form"
              method="POST"
              hx-post="{% if customer %}{% url 'customers:edit' customer_id=customer.id %}{% else %}{% url 'customers:create' %}{% endif %}"
              hx-target="#main-content-area"
              hx-push-url="{% url 'customers:list' %}">
            {% csrf_token %}

            {# Basic Information #}
            <div class="form-grid form-grid--2col mb-lg">
                <ion-item>
                    <ion-input
                        label="{% trans 'Name' %} *"
                        label-placement="stacked"
                        type="text"
                        name="name"
                        value="{{ customer.name|default:'' }}"
                        required
                        placeholder="{% trans 'Customer name' %}">
                    </ion-input>
                </ion-item>

                <ion-item>
                    <ion-input
                        label="{% trans 'Tax ID' %}"
                        label-placement="stacked"
                        type="text"
                        name="tax_id"
                        value="{{ customer.tax_id|default:'' }}"
                        placeholder="{% trans 'ID/VAT number' %}">
                    </ion-input>
                </ion-item>
            </div>

            {# Contact Information #}
            <h3 class="form-section-title">
                <ion-icon name="call-outline"></ion-icon>
                {% trans "Contact" %}
            </h3>

            <div class="form-grid form-grid--2col mb-lg">
                <ion-item>
                    <ion-input
                        label="{% trans 'Phone' %}"
                        label-placement="stacked"
                        type="tel"
                        name="phone"
                        value="{{ customer.phone|default:'' }}"
                        placeholder="+34 600 000 000">
                    </ion-input>
                </ion-item>

                <ion-item>
                    <ion-input
                        label="{% trans 'Email' %}"
                        label-placement="stacked"
                        type="email"
                        name="email"
                        value="{{ customer.email|default:'' }}"
                        placeholder="customer@example.com">
                    </ion-input>
                </ion-item>
            </div>

            <div class="mb-lg">
                <ion-item>
                    <ion-textarea
                        label="{% trans 'Address' %}"
                        label-placement="stacked"
                        name="address"
                        rows="2"
                        placeholder="{% trans 'Street, city, postal code' %}">{{ customer.address|default:'' }}</ion-textarea>
                </ion-item>
            </div>

            {# Notes #}
            <div class="mb-lg">
                <ion-item>
                    <ion-textarea
                        label="{% trans 'Notes' %}"
                        label-placement="stacked"
                        name="notes"
                        rows="3"
                        placeholder="{% trans 'Additional observations...' %}">{{ customer.notes|default:'' }}</ion-textarea>
                </ion-item>
            </div>

            {% if customer %}
            {# Status (only for edit) #}
            <div class="mb-lg">
                <ion-item>
                    <ion-toggle name="is_active" {% if customer.is_active %}checked{% endif %} justify="start" label-placement="end">
                        {% trans "Active Customer" %}
                    </ion-toggle>
                </ion-item>
            </div>
            {% endif %}

            {# Actions #}
            <div class="form-actions">
                <div></div>
                <div class="d-flex gap-sm">
                    <ion-button fill="outline" type="button"
                                hx-get="{% url 'customers:list' %}"
                                hx-target="#main-content-area"
                                hx-push-url="true">
                        <ion-icon slot="start" name="close-outline"></ion-icon>
                        {% trans "Cancel" %}
                    </ion-button>

                    <ion-button type="submit" id="save-btn" color="success">
                        <ion-icon id="save-icon" slot="start" name="checkmark-outline"></ion-icon>
                        <ion-spinner id="save-spinner" name="crescent" slot="start" style="width: 20px; height: 20px; display: none;"></ion-spinner>
                        <span id="save-text">{% trans "Save" %}</span>
                    </ion-button>
                </div>
            </div>
        </form>
    {% endui_card %}

    {% if customer %}
    {# Customer Stats (only for edit) #}
    {% ui_card css_class="mt-md" %}
        <div class="d-flex justify-between align-center mb-md">
            <span class="fw-semibold fs-lg">{% trans "Statistics" %}</span>
            <ion-button fill="outline" size="small"
                        hx-post="{% url 'customers:update_stats' customer_id=customer.id %}"
                        hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                        hx-swap="none">
                <ion-icon slot="start" name="refresh-outline"></ion-icon>
                {% trans "Update" %}
            </ion-button>
        </div>

        <div class="d-flex gap-sm flex-wrap">
            <div class="stat-box stat-box--success">
                <span class="stat-box__label">{% trans "Total Spent" %}</span>
                <span class="stat-box__value">{{ customer.total_spent|floatformat:2 }} €</span>
            </div>
            <div class="stat-box stat-box--primary">
                <span class="stat-box__label">{% trans "Visits" %}</span>
                <span class="stat-box__value">{{ customer.visit_count }}</span>
            </div>
            <div class="stat-box">
                <span class="stat-box__label">{% trans "Avg. Purchase" %}</span>
                <span class="stat-box__value">{{ customer.average_purchase|floatformat:2 }} €</span>
            </div>
        </div>
    {% endui_card %}
    {% endif %}
    {% endfill %}
{% endcomponent %}

<script>
(function() {
    var form = document.getElementById('customer-form');
    var saveBtn = document.getElementById('save-btn');
    var saveIcon = document.getElementById('save-icon');
    var saveSpinner = document.getElementById('save-spinner');
    var saveText = document.getElementById('save-text');

    if (form) {
        // Show loading state on submit
        form.addEventListener('htmx:beforeRequest', function() {
            if (saveBtn) saveBtn.disabled = true;
            if (saveIcon) saveIcon.style.display = 'none';
            if (saveSpinner) saveSpinner.style.display = '';
            if (saveText) saveText.textContent = '{% trans "Saving..." %}';
        });

        // Reset loading state after request
        form.addEventListener('htmx:afterRequest', function() {
            if (saveBtn) saveBtn.disabled = false;
            if (saveIcon) saveIcon.style.display = '';
            if (saveSpinner) saveSpinner.style.display = 'none';
            if (saveText) saveText.textContent = '{% trans "Save" %}';
        });
    }
})();
</script>

<style>
.form-grid {
    display: grid;
    gap: 0;
}

.form-grid--2col {
    grid-template-columns: repeat(2, 1fr);
}

@media (max-width: 768px) {
    .form-grid--2col {
        grid-template-columns: 1fr;
    }
}

.form-section-title {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--text-color);
    margin-bottom: var(--space-md);
}

.form-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--space-sm);
    padding-top: var(--space-md);
    margin-top: var(--space-md);
    border-top: 1px solid var(--border-color);
}

.stat-box {
    flex: 1;
    min-width: 120px;
    padding: var(--space-md);
    border-radius: var(--border-radius);
    background: var(--bg-color-secondary);
    text-align: center;
}

.stat-box--success {
    background: rgba(var(--color-success-rgb), 0.1);
}

.stat-box--success .stat-box__value {
    color: var(--color-success);
}

.stat-box--primary {
    background: rgba(var(--color-primary-rgb), 0.1);
}

.stat-box--primary .stat-box__value {
    color: var(--color-primary);
}

.stat-box__label {
    display: block;
    font-size: var(--font-size-sm);
    color: var(--text-color-secondary);
    margin-bottom: var(--space-xxs);
}

.stat-box__value {
    display: block;
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-bold);
    color: var(--text-color);
}
</style>
