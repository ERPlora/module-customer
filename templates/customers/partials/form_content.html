{% load i18n ui %}

{% if request.htmx %}
{# Clear tab bar for form pages - they use back button navigation #}
<div id="dashboard-tabbar" hx-swap-oob="innerHTML"></div>
{% endif %}

{# Register Alpine.js component using Alpine.data() for proper HTMX compatibility #}
<script>
(function() {
    // Form data from Django context - must be extracted before the IIFE runs
    const initialFormData = {
        name: '{{ customer.name|default:""|escapejs }}',
        tax_id: '{{ customer.tax_id|default:""|escapejs }}',
        phone: '{{ customer.phone|default:""|escapejs }}',
        email: '{{ customer.email|default:""|escapejs }}',
        address: '{{ customer.address|default:""|escapejs }}',
        notes: '{{ customer.notes|default:""|escapejs }}',
        is_active: {{ customer.is_active|yesno:"true,false"|default:"true" }}
    };
    const submitUrl = {% if customer %}'{% url "customers:edit" customer_id=customer.id %}'{% else %}'{% url "customers:create" %}'{% endif %};
    const listUrl = '{% url "customers:list" %}';
    const csrfToken = '{{ csrf_token }}';

    const customerFormData = () => ({
        form: { ...initialFormData },
        saving: false,

        async submitForm() {
            if (!this.form.name.trim()) {
                const toast = document.createElement('ion-toast');
                toast.message = '{% trans "Name is required" %}';
                toast.duration = 3000;
                toast.color = 'danger';
                toast.position = 'top';
                document.body.appendChild(toast);
                await toast.present();
                return;
            }

            this.saving = true;

            try {
                const formData = new FormData();
                formData.append('name', this.form.name);
                formData.append('tax_id', this.form.tax_id);
                formData.append('phone', this.form.phone);
                formData.append('email', this.form.email);
                formData.append('address', this.form.address);
                formData.append('notes', this.form.notes);
                if (this.form.is_active) {
                    formData.append('is_active', 'on');
                }

                const response = await fetch(submitUrl, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    const toast = document.createElement('ion-toast');
                    toast.message = data.message;
                    toast.duration = 2000;
                    toast.color = 'success';
                    toast.position = 'top';
                    document.body.appendChild(toast);
                    await toast.present();

                    htmx.ajax('GET', listUrl, {
                        target: '#main-content-area',
                        swap: 'innerHTML'
                    });
                    history.pushState({}, '', listUrl);
                } else {
                    throw new Error(data.error || '{% trans "Error saving" %}');
                }
            } catch (error) {
                const toast = document.createElement('ion-toast');
                toast.message = error.message;
                toast.duration = 3000;
                toast.color = 'danger';
                toast.position = 'top';
                document.body.appendChild(toast);
                await toast.present();
            } finally {
                this.saving = false;
            }
        }
    });

    // Register with Alpine.data() if Alpine is ready, otherwise queue it
    if (typeof Alpine !== 'undefined' && Alpine.data) {
        Alpine.data('customerForm', customerFormData);
    } else {
        document.addEventListener('alpine:init', () => {
            Alpine.data('customerForm', customerFormData);
        }, { once: true });
    }

    // Also make it available as a global function for backwards compatibility
    window.customerForm = customerFormData;
})();
</script>

<div x-data="customerForm()">
    {# Page Header #}
    {% url 'customers:list' as back_url %}
    {% if customer %}
    {% ui_page_header title=_("Edit Customer") subtitle=customer.name back_url=back_url back_hx_target="#main-content-area" %}
    {% else %}
    {% ui_page_header title=_("New Customer") back_url=back_url back_hx_target="#main-content-area" %}
    {% endif %}

    {% ui_card %}
        <form @submit.prevent="submitForm()">
            {% csrf_token %}

            {# Basic Information #}
            <div class="form-grid form-grid--2col mb-lg">
                <ion-item>
                    <ion-input
                        label="{% trans 'Name' %} *"
                        label-placement="stacked"
                        type="text"
                        name="name"
                        x-model="form.name"
                        required
                        placeholder="{% trans 'Customer name' %}">
                    </ion-input>
                </ion-item>

                <ion-item>
                    <ion-input
                        label="{% trans 'Tax ID' %}"
                        label-placement="stacked"
                        type="text"
                        name="tax_id"
                        x-model="form.tax_id"
                        placeholder="{% trans 'ID/VAT number' %}">
                    </ion-input>
                </ion-item>
            </div>

            {# Contact Information #}
            <h3 class="form-section-title">
                <ion-icon name="call-outline"></ion-icon>
                {% trans "Contact" %}
            </h3>

            <div class="form-grid form-grid--2col mb-lg">
                <ion-item>
                    <ion-input
                        label="{% trans 'Phone' %}"
                        label-placement="stacked"
                        type="tel"
                        name="phone"
                        x-model="form.phone"
                        placeholder="+34 600 000 000">
                    </ion-input>
                </ion-item>

                <ion-item>
                    <ion-input
                        label="{% trans 'Email' %}"
                        label-placement="stacked"
                        type="email"
                        name="email"
                        x-model="form.email"
                        placeholder="customer@example.com">
                    </ion-input>
                </ion-item>
            </div>

            <div class="mb-lg">
                <ion-item>
                    <ion-textarea
                        label="{% trans 'Address' %}"
                        label-placement="stacked"
                        name="address"
                        x-model="form.address"
                        rows="2"
                        placeholder="{% trans 'Street, city, postal code' %}">
                    </ion-textarea>
                </ion-item>
            </div>

            {# Notes #}
            <div class="mb-lg">
                <ion-item>
                    <ion-textarea
                        label="{% trans 'Notes' %}"
                        label-placement="stacked"
                        name="notes"
                        x-model="form.notes"
                        rows="3"
                        placeholder="{% trans 'Additional observations...' %}">
                    </ion-textarea>
                </ion-item>
            </div>

            {% if customer %}
            {# Status (only for edit) #}
            <div class="mb-lg">
                <ion-item>
                    <ion-toggle name="is_active" x-model="form.is_active" :checked="form.is_active" justify="start" label-placement="end">
                        {% trans "Active Customer" %}
                    </ion-toggle>
                </ion-item>
            </div>
            {% endif %}

            {# Actions #}
            <div class="form-actions">
                <div></div>
                <div class="d-flex gap-sm">
                    <ion-button fill="outline" type="button"
                                hx-get="{% url 'customers:list' %}"
                                hx-target="#main-content-area"
                                hx-push-url="true">
                        <ion-icon slot="start" name="close-outline"></ion-icon>
                        {% trans "Cancel" %}
                    </ion-button>

                    <ion-button type="submit" :disabled="saving" color="success">
                        <ion-spinner x-show="saving" name="crescent" style="width: 20px; height: 20px;"></ion-spinner>
                        <ion-icon x-show="!saving" slot="start" name="checkmark-outline"></ion-icon>
                        <span x-text="saving ? '{% trans "Saving..." %}' : '{% trans "Save" %}'"></span>
                    </ion-button>
                </div>
            </div>
        </form>
    {% endui_card %}

    {% if customer %}
    {# Customer Stats (only for edit) #}
    {% ui_card css_class="mt-md" %}
        <div class="d-flex justify-between align-center mb-md">
            <span class="fw-semibold fs-lg">{% trans "Statistics" %}</span>
            <ion-button fill="outline" size="small"
                        hx-post="{% url 'customers:update_stats' customer_id=customer.id %}"
                        hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                        hx-swap="none">
                <ion-icon slot="start" name="refresh-outline"></ion-icon>
                {% trans "Update" %}
            </ion-button>
        </div>

        <div class="d-flex gap-sm flex-wrap">
            <div class="stat-box stat-box--success">
                <span class="stat-box__label">{% trans "Total Spent" %}</span>
                <span class="stat-box__value">{{ customer.total_spent|floatformat:2 }} €</span>
            </div>
            <div class="stat-box stat-box--primary">
                <span class="stat-box__label">{% trans "Visits" %}</span>
                <span class="stat-box__value">{{ customer.visit_count }}</span>
            </div>
            <div class="stat-box">
                <span class="stat-box__label">{% trans "Avg. Purchase" %}</span>
                <span class="stat-box__value">{{ customer.average_purchase|floatformat:2 }} €</span>
            </div>
        </div>
    {% endui_card %}
    {% endif %}
</div>

<style>
.form-grid {
    display: grid;
    gap: 0;
}

.form-grid--2col {
    grid-template-columns: repeat(2, 1fr);
}

@media (max-width: 768px) {
    .form-grid--2col {
        grid-template-columns: 1fr;
    }
}

.form-section-title {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--text-color);
    margin-bottom: var(--space-md);
}

.form-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--space-sm);
    padding-top: var(--space-md);
    margin-top: var(--space-md);
    border-top: 1px solid var(--border-color);
}

.stat-box {
    flex: 1;
    min-width: 120px;
    padding: var(--space-md);
    border-radius: var(--border-radius);
    background: var(--bg-color-secondary);
    text-align: center;
}

.stat-box--success {
    background: rgba(var(--color-success-rgb), 0.1);
}

.stat-box--success .stat-box__value {
    color: var(--color-success);
}

.stat-box--primary {
    background: rgba(var(--color-primary-rgb), 0.1);
}

.stat-box--primary .stat-box__value {
    color: var(--color-primary);
}

.stat-box__label {
    display: block;
    font-size: var(--font-size-sm);
    color: var(--text-color-secondary);
    margin-bottom: var(--space-xxs);
}

.stat-box__value {
    display: block;
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-bold);
    color: var(--text-color);
}
</style>
