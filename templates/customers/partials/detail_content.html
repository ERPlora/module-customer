{% load i18n ui component_tags %}

{% component "page"
    title=customer.name
    module_id="customers"
    tabbar_view="list"
    action_icon="create-outline"
    action_label=_("Edit")
    action_hx_get="/modules/customers/"|add:customer.id|add:"/edit/"
    action_hx_target="#main-content-area"
    action_hx_push_url="true" %}

    {% fill "content" %}
{# Customer Status Badge #}
    <div class="mb-md">
        {% if customer.is_active %}
        <ion-badge color="success">{% trans "Active" %}</ion-badge>
        {% else %}
        <ion-badge color="medium">{% trans "Inactive" %}</ion-badge>
        {% endif %}
        {% if customer.tax_id %}<span class="ml-sm text-secondary">{{ customer.tax_id }}</span>{% endif %}
    </div>

<div class="customer-detail-grid">
    {# Left Column: Customer Info #}
    <div class="customer-detail-sidebar">
        {# Contact Card #}
        {% ui_card %}
            <div class="d-flex justify-between align-center mb-md">
                <span class="fw-semibold fs-lg">{% trans "Contact Information" %}</span>
            </div>

            <ion-list lines="none">
                <ion-item>
                    <ion-icon name="call-outline" slot="start" color="primary"></ion-icon>
                    <ion-label>
                        <p class="text-secondary fs-sm">{% trans "Phone" %}</p>
                        <h3>{{ customer.phone|default:"—" }}</h3>
                    </ion-label>
                    {% if customer.phone %}
                    <ion-button slot="end" fill="clear" href="tel:{{ customer.phone }}">
                        <ion-icon slot="icon-only" name="call"></ion-icon>
                    </ion-button>
                    {% endif %}
                </ion-item>

                <ion-item>
                    <ion-icon name="mail-outline" slot="start" color="primary"></ion-icon>
                    <ion-label>
                        <p class="text-secondary fs-sm">{% trans "Email" %}</p>
                        <h3>{{ customer.email|default:"—" }}</h3>
                    </ion-label>
                    {% if customer.email %}
                    <ion-button slot="end" fill="clear" href="mailto:{{ customer.email }}">
                        <ion-icon slot="icon-only" name="mail"></ion-icon>
                    </ion-button>
                    {% endif %}
                </ion-item>

                <ion-item>
                    <ion-icon name="location-outline" slot="start" color="primary"></ion-icon>
                    <ion-label>
                        <p class="text-secondary fs-sm">{% trans "Address" %}</p>
                        <h3 style="white-space: pre-wrap;">{{ customer.address|default:"—" }}</h3>
                    </ion-label>
                </ion-item>

                <ion-item>
                    <ion-icon name="document-text-outline" slot="start" color="primary"></ion-icon>
                    <ion-label>
                        <p class="text-secondary fs-sm">{% trans "Tax ID" %}</p>
                        <h3>{{ customer.tax_id|default:"—" }}</h3>
                    </ion-label>
                </ion-item>
            </ion-list>
        {% endui_card %}

        {# Notes Card #}
        {% if customer.notes %}
        {% ui_card %}
            <div class="d-flex justify-between align-center mb-md">
                <span class="fw-semibold fs-lg">{% trans "Notes" %}</span>
            </div>
            <p style="white-space: pre-wrap;">{{ customer.notes }}</p>
        {% endui_card %}
        {% endif %}

        {# Dates Card #}
        {% ui_card %}
            <div class="d-flex justify-between align-center mb-md">
                <span class="fw-semibold fs-lg">{% trans "Dates" %}</span>
            </div>

            <ion-list lines="none">
                <ion-item>
                    <ion-icon name="calendar-outline" slot="start" color="medium"></ion-icon>
                    <ion-label>
                        <p class="text-secondary fs-sm">{% trans "Customer since" %}</p>
                        <h3>{{ customer.created_at|date:"d/m/Y" }}</h3>
                    </ion-label>
                </ion-item>
                <ion-item>
                    <ion-icon name="time-outline" slot="start" color="medium"></ion-icon>
                    <ion-label>
                        <p class="text-secondary fs-sm">{% trans "Last update" %}</p>
                        <h3>{{ customer.updated_at|date:"d/m/Y H:i" }}</h3>
                    </ion-label>
                </ion-item>
            </ion-list>
        {% endui_card %}
    </div>

    {# Right Column: Stats & History #}
    <div class="customer-detail-main">
        {# Stats Cards #}
        <div class="d-flex gap-sm mb-md flex-wrap">
            {% ui_stat_card value=customer.total_spent|floatformat:2|add:" €" label=_("Total Spent") icon="cash-outline" color="success" %}
            {% ui_stat_card value=customer.visit_count label=_("Visits") icon="repeat-outline" color="primary" %}
            {% ui_stat_card value=customer.average_purchase|floatformat:2|add:" €" label=_("Avg. Purchase") icon="analytics-outline" %}
        </div>

        {# Recent Purchases #}
        {% ui_card %}
            <div class="d-flex justify-between align-center mb-md">
                <span class="fw-semibold fs-lg">{% trans "Recent Purchases" %}</span>
            </div>

            {% if recent_purchases %}
            <ion-list>
                {% for sale in recent_purchases %}
                <ion-item>
                    <ion-icon name="receipt-outline" slot="start" color="primary"></ion-icon>
                    <ion-label>
                        <h2>{% trans "Sale" %} #{{ sale.id }}</h2>
                        <p class="text-secondary">{{ sale.created_at|date:"d/m/Y H:i" }}</p>
                    </ion-label>
                    <ion-note slot="end" class="fw-semibold text-success fs-lg">
                        {{ sale.total|floatformat:2 }} €
                    </ion-note>
                </ion-item>
                {% endfor %}
            </ion-list>
            {% else %}
            <div class="ui-empty-state">
                <div class="ui-empty-state__icon">
                    <ion-icon name="cart-outline"></ion-icon>
                </div>
                <h3 class="ui-empty-state__title">{% trans "No purchases recorded" %}</h3>
            </div>
            {% endif %}
        {% endui_card %}
    </div>
</div>
    {% endfill %}
{% endcomponent %}

<style>
.customer-detail-grid {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: var(--space-md);
}

@media (max-width: 992px) {
    .customer-detail-grid {
        grid-template-columns: 1fr;
    }
}

.customer-detail-sidebar {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
}

.customer-detail-main {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
}

ion-list {
    padding: 0;
}
</style>
